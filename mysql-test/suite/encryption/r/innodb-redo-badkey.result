call mtr.add_suppression("InnoDB: Block in space_id .* in file .* encrypted.");
call mtr.add_suppression("InnoDB: However key management plugin or used key_version 1 is not found or used encryption algorithm or method does not match.");
call mtr.add_suppression("InnoDB: Marking tablespace as missing. You may drop this table or install correct key management plugin and key file.");
# Restart mysqld --file-key-management-filename=keys1.txt --innodb-change-buffering=none
SET GLOBAL innodb_file_format = `Barracuda`;
SET GLOBAL innodb_file_per_table = ON;
set GLOBAL innodb_default_encryption_key_id=4;
create table t1(a int not null primary key auto_increment, c char(200), b blob) engine=innodb row_format=compressed encrypted=yes;
create table t2(a int not null primary key auto_increment, c char(200), b blob) engine=innodb row_format=compressed;
create table t3(a int not null primary key auto_increment, c char(200), b blob) engine=innodb encrypted=yes;
create table t4(a int not null primary key auto_increment, c char(200), b blob) engine=innodb;
CREATE INDEX test ON t1 (b(10));
CREATE INDEX test ON t2 (b(10));
CREATE INDEX test ON t3 (b(10));
CREATE INDEX test ON t4 (b(10));
begin;
insert into t2 select * from t1;
insert into t3 select * from t1;
insert into t4 select * from t1;
commit;
SET GLOBAL innodb_buf_flush_list_now = 1;
SET GLOBAL innodb_flush_log_at_trx_commit=1;
begin;
update t1 set c = repeat('secret3', 20);
update t2 set c = repeat('secret4', 20);
update t3 set c = repeat('secret4', 20);
update t4 set c = repeat('secret4', 20);
insert into t1 (c,b) values (repeat('secret5',20), repeat('secret6',6000));
insert into t2 (c,b) values (repeat('secret7',20), repeat('secret8',6000));
insert into t3 (c,b) values (repeat('secret9',20), repeat('secre10',6000));
insert into t4 (c,b) values (repeat('secre11',20), repeat('secre12',6000));
COMMIT;
# Kill the server
# Restart mysqld --file-key-management-filename=keys2.txt
# Restart mysqld --file-key-management-filename=keys1.txt
select count(*) from t1;
count(*)
21
select count(*) from t2;
count(*)
21
select count(*) from t3;
count(*)
21
select count(*) from t4;
count(*)
21
drop table t1, t2,t3,t4;
