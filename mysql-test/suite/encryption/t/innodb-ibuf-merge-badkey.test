-- source include/have_innodb.inc
-- source include/have_file_key_management_plugin.inc
# embedded does not support restart
-- source include/not_embedded.inc
# Don't test this under valgrind, memory leaks will occur.
--source include/not_valgrind.inc
# Avoid CrashReporter popup on Mac
--source include/not_crashrep.inc
--source include/not_windows.inc

call mtr.add_suppression("InnoDB: Block in space_id .* in file .* encrypted.");
call mtr.add_suppression("InnoDB: However key management plugin or used key_version 1 is not found or used encryption algorithm or method does not match.");
call mtr.add_suppression("InnoDB: Marking tablespace as missing. You may drop this table or install correct key management plugin and key file.");

--disable_query_log
let $innodb_file_format_orig = `SELECT @@innodb_file_format`;
let $innodb_file_per_table_orig = `SELECT @@innodb_file_per_table`;
--enable_query_log

--write_file $MYSQLTEST_VARDIR/keys1.txt
1;770A8A65DA156D24EE2A093277530142
4;770A8A65DA156D24EE2A093277530143
EOF

--echo # Restart mysqld --file-key-management-filename=keys1.txt
-- let $restart_parameters=--plugin-load-add=file_key_management.so --file-key-management --file-key-management-filename=$MYSQLTEST_VARDIR/keys1.txt
-- source include/restart_mysqld.inc

--disable_warnings
SET GLOBAL innodb_file_format = `Barracuda`;
SET GLOBAL innodb_file_per_table = ON;
--enable_warnings

set GLOBAL innodb_default_encryption_key_id=4;
create table t1(a int not null primary key auto_increment, c char(200), b blob) engine=innodb row_format=compressed encrypted=yes;
create table t2(a int not null primary key auto_increment, c char(200), b blob) engine=innodb row_format=compressed;
create table t3(a int not null primary key auto_increment, c char(200), b blob) engine=innodb encrypted=yes;
create table t4(a int not null primary key auto_increment, c char(200), b blob) engine=innodb;
CREATE INDEX test ON t1 (b(10));
CREATE INDEX test ON t2 (b(10));
CREATE INDEX test ON t3 (b(10));
CREATE INDEX test ON t4 (b(10));

--disable_query_log
--let $i = 20
begin;
while ($i)
{
  insert into t1(c,b) values (repeat('secret1',20), repeat('secret2',6000));
  dec $i;
}
commit;
--enable_query_log

begin;
insert into t2 select * from t1;
insert into t3 select * from t1;
insert into t4 select * from t1;
commit;

#--source ../../suite/innodb/include/no_checkpoint_start.inc
begin;
update t1 set c = repeat('secret3', 20);
update t2 set c = repeat('secret4', 20);
update t3 set c = repeat('secret4', 20);
update t4 set c = repeat('secret4', 20);
insert into t1 (c,b) values (repeat('secret5',20), repeat('secret6',6000));
insert into t2 (c,b) values (repeat('secret7',20), repeat('secret8',6000));
insert into t3 (c,b) values (repeat('secret9',20), repeat('secre10',6000));
insert into t4 (c,b) values (repeat('secre11',20), repeat('secre12',6000));
SET GLOBAL innodb_buf_flush_list_now = 1;
SET GLOBAL innodb_flush_log_at_trx_commit=1;
COMMIT;

--source include/kill_mysqld.inc

--write_file $MYSQLTEST_VARDIR/keys2.txt
1;770A8A65DA156D24EE2A093277530998
4;770A8A65DA156D24EE2A093277530999
EOF

#
# Can't start because pages are encrypted with different key
#
# The crash is expected
--echo # Restart mysqld --file-key-management-filename=keys2.txt
-- let $restart_parameters=--plugin-load-add=file_key_management.so --file-key-management --file-key-management-filename=$MYSQLTEST_VARDIR/keys2.txt
--error 2013
--enable_reconnect

--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect;
--echo # Restart mysqld --file-key-management-filename=keys1.txt
-- let $restart_parameters=--plugin-load-add=file_key_management.so --file-key-management --file-key-management-filename=$MYSQLTEST_VARDIR/keys1.txt
-- source include/start_mysqld.inc

select count(*) from t1;
select count(*) from t2;
select count(*) from t3;
select count(*) from t4;

drop table t1, t2,t3,t4;

--remove_file $MYSQLTEST_VARDIR/keys1.txt
--remove_file $MYSQLTEST_VARDIR/keys2.txt
